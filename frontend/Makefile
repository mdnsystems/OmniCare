# ===========================================
# Makefile para OmniCare Frontend Docker
# ===========================================

.PHONY: help dev dev-full preview build prod nginx logs stop clean reset backup health monitor

# VariÃ¡veis
DOCKER_COMPOSE = docker-compose
DOCKER_DEV_SCRIPT = ./scripts/docker-dev.sh
DOCKER_PROD_SCRIPT = ./scripts/docker-prod.sh

# Comando padrÃ£o
help: ## Mostra esta ajuda
	@echo "ğŸ³ OmniCare Frontend - Comandos Docker"
	@echo "======================================"
	@echo ""
	@echo "Desenvolvimento:"
	@echo "  make dev        - Inicia ambiente de desenvolvimento"
	@echo "  make dev-full   - Inicia ambiente completo (frontend + backend mock)"
	@echo "  make preview    - Inicia preview de produÃ§Ã£o"
	@echo "  make build      - Faz build de produÃ§Ã£o"
	@echo ""
	@echo "ProduÃ§Ã£o:"
	@echo "  make prod       - Deploy de produÃ§Ã£o"
	@echo "  make nginx      - Deploy com nginx reverso"
	@echo "  make health     - Health check da aplicaÃ§Ã£o"
	@echo "  make backup     - Cria backup da aplicaÃ§Ã£o"
	@echo ""
	@echo "Gerenciamento:"
	@echo "  make logs       - Mostra logs"
	@echo "  make stop       - Para todos os containers"
	@echo "  make clean      - Limpa containers e imagens"
	@echo "  make reset      - Reset completo"
	@echo "  make monitor    - Monitoramento em tempo real"
	@echo ""
	@echo "Para mais detalhes, consulte DOCKER.md"

# ===========================================
# Desenvolvimento
# ===========================================

dev: ## Inicia ambiente de desenvolvimento
	@echo "ğŸš€ Iniciando ambiente de desenvolvimento..."
	$(DOCKER_DEV_SCRIPT) dev

dev-full: ## Inicia ambiente completo (frontend + backend mock)
	@echo "ğŸš€ Iniciando ambiente completo..."
	$(DOCKER_DEV_SCRIPT) dev-full

preview: ## Inicia preview de produÃ§Ã£o
	@echo "ğŸ‘€ Iniciando preview de produÃ§Ã£o..."
	$(DOCKER_DEV_SCRIPT) preview

build: ## Faz build de produÃ§Ã£o
	@echo "ğŸ”¨ Fazendo build de produÃ§Ã£o..."
	$(DOCKER_DEV_SCRIPT) build

# ===========================================
# ProduÃ§Ã£o
# ===========================================

prod: ## Deploy de produÃ§Ã£o
	@echo "ğŸš€ Fazendo deploy de produÃ§Ã£o..."
	$(DOCKER_PROD_SCRIPT) deploy

nginx: ## Deploy com nginx reverso
	@echo "ğŸŒ Fazendo deploy com nginx reverso..."
	$(DOCKER_PROD_SCRIPT) nginx

health: ## Health check da aplicaÃ§Ã£o
	@echo "ğŸ¥ Verificando saÃºde da aplicaÃ§Ã£o..."
	$(DOCKER_PROD_SCRIPT) health

backup: ## Cria backup da aplicaÃ§Ã£o
	@echo "ğŸ’¾ Criando backup da aplicaÃ§Ã£o..."
	$(DOCKER_PROD_SCRIPT) backup

# ===========================================
# Gerenciamento
# ===========================================

logs: ## Mostra logs
	@echo "ğŸ“‹ Mostrando logs..."
	$(DOCKER_DEV_SCRIPT) logs

logs-full: ## Mostra logs de todos os serviÃ§os
	@echo "ğŸ“‹ Mostrando logs completos..."
	$(DOCKER_DEV_SCRIPT) logs full

stop: ## Para todos os containers
	@echo "â¹ï¸ Parando containers..."
	$(DOCKER_DEV_SCRIPT) stop

clean: ## Limpa containers e imagens
	@echo "ğŸ§¹ Limpando containers e imagens..."
	$(DOCKER_COMPOSE) down --remove-orphans -v
	docker system prune -f
	@echo "âœ… Limpeza concluÃ­da!"

reset: ## Reset completo
	@echo "ğŸ”„ Fazendo reset completo..."
	$(DOCKER_DEV_SCRIPT) reset

monitor: ## Monitoramento em tempo real
	@echo "ğŸ“Š Iniciando monitoramento..."
	$(DOCKER_PROD_SCRIPT) monitor

# ===========================================
# Comandos Docker Compose Diretos
# ===========================================

up-dev: ## Docker compose up para desenvolvimento
	$(DOCKER_COMPOSE) --profile dev up --build -d

up-dev-full: ## Docker compose up para desenvolvimento completo
	$(DOCKER_COMPOSE) --profile dev-full up --build -d

up-preview: ## Docker compose up para preview
	$(DOCKER_COMPOSE) --profile preview up --build -d

up-prod: ## Docker compose up para produÃ§Ã£o
	$(DOCKER_COMPOSE) --profile prod up --build -d

up-nginx: ## Docker compose up com nginx
	$(DOCKER_COMPOSE) --profile nginx up --build -d

down: ## Docker compose down
	$(DOCKER_COMPOSE) down --remove-orphans

ps: ## Mostra status dos containers
	$(DOCKER_COMPOSE) ps

# ===========================================
# UtilitÃ¡rios
# ===========================================

shell: ## Entra no container de desenvolvimento
	$(DOCKER_COMPOSE) exec frontend-dev sh

shell-prod: ## Entra no container de produÃ§Ã£o
	$(DOCKER_COMPOSE) exec frontend-prod sh

stats: ## Mostra estatÃ­sticas dos containers
	docker stats

env: ## Copia arquivo de ambiente
	@if [ ! -f .env ]; then \
		echo "ğŸ“ Copiando env.example para .env..."; \
		cp env.example .env; \
		echo "âœ… Arquivo .env criado. Configure as variÃ¡veis de ambiente."; \
	else \
		echo "â„¹ï¸ Arquivo .env jÃ¡ existe."; \
	fi

check: ## Verifica se Docker estÃ¡ rodando
	@if docker info > /dev/null 2>&1; then \
		echo "âœ… Docker estÃ¡ rodando"; \
	else \
		echo "âŒ Docker nÃ£o estÃ¡ rodando. Inicie o Docker Desktop."; \
		exit 1; \
	fi

# ===========================================
# Desenvolvimento AvanÃ§ado
# ===========================================

install: ## Instala dependÃªncias localmente
	@echo "ğŸ“¦ Instalando dependÃªncias..."
	npm ci

dev-local: ## Desenvolvimento local (sem Docker)
	@echo "ğŸš€ Iniciando desenvolvimento local..."
	npm run dev

build-local: ## Build local (sem Docker)
	@echo "ğŸ”¨ Fazendo build local..."
	npm run build

lint: ## Executa linter
	@echo "ğŸ” Executando linter..."
	npm run lint

# ===========================================
# Deploy AvanÃ§ado
# ===========================================

deploy-staging: ## Deploy para staging
	@echo "ğŸš€ Fazendo deploy para staging..."
	$(DOCKER_PROD_SCRIPT) deploy

deploy-prod: ## Deploy para produÃ§Ã£o
	@echo "ğŸš€ Fazendo deploy para produÃ§Ã£o..."
	$(DOCKER_PROD_SCRIPT) deploy

rollback: ## Rollback (especifique o backup)
	@if [ -z "$(BACKUP)" ]; then \
		echo "âŒ Especifique o diretÃ³rio de backup: make rollback BACKUP=./backups/20241201_143022"; \
		exit 1; \
	fi
	@echo "ğŸ”„ Fazendo rollback de $(BACKUP)..."
	$(DOCKER_PROD_SCRIPT) rollback $(BACKUP)

# ===========================================
# DocumentaÃ§Ã£o
# ===========================================

docs: ## Abre documentaÃ§Ã£o Docker
	@if command -v xdg-open > /dev/null; then \
		xdg-open DOCKER.md; \
	elif command -v open > /dev/null; then \
		open DOCKER.md; \
	else \
		echo "ğŸ“– Abra o arquivo DOCKER.md para ver a documentaÃ§Ã£o"; \
	fi

readme: ## Mostra README do projeto
	@if [ -f README.md ]; then \
		cat README.md; \
	else \
		echo "ğŸ“– README.md nÃ£o encontrado"; \
	fi

# ===========================================
# InformaÃ§Ãµes do Sistema
# ===========================================

info: ## Mostra informaÃ§Ãµes do sistema
	@echo "ğŸ³ InformaÃ§Ãµes do Docker:"
	@docker --version
	@docker-compose --version
	@echo ""
	@echo "ğŸ“¦ InformaÃ§Ãµes do Node.js:"
	@node --version
	@npm --version
	@echo ""
	@echo "ğŸ“ InformaÃ§Ãµes do Projeto:"
	@echo "DiretÃ³rio: $(PWD)"
	@echo "Branch: $(shell git branch --show-current 2>/dev/null || echo 'N/A')"
	@echo "Commit: $(shell git rev-parse --short HEAD 2>/dev/null || echo 'N/A')"

version: ## Mostra versÃ£o do projeto
	@echo "ğŸ“‹ VersÃ£o do projeto:"
	@if [ -f package.json ]; then \
		echo "Nome: $(shell node -p "require('./package.json').name")"; \
		echo "VersÃ£o: $(shell node -p "require('./package.json').version")"; \
	else \
		echo "package.json nÃ£o encontrado"; \
	fi 